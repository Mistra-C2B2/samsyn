#!/bin/bash
# Pre-commit hook for SamSyn
# Runs linters and formatters on staged files

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}Running pre-commit checks...${NC}"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Track if we have errors
HAS_ERRORS=0

# Check if there are any staged backend Python files
BACKEND_FILES=$(echo "$STAGED_FILES" | grep "^backend/.*\.py$" || true)

if [ -n "$BACKEND_FILES" ]; then
    echo -e "${BLUE}Checking backend files...${NC}"

    # Change to backend directory
    cd backend

    # Run ruff check with auto-fix (excluding tests)
    echo "Running ruff check..."
    if ! uv run ruff check --fix --exclude tests .; then
        echo -e "${RED}❌ Ruff found errors that couldn't be auto-fixed${NC}"
        HAS_ERRORS=1
    else
        echo -e "${GREEN}✓ Ruff check passed${NC}"
    fi

    # Run ruff format (including tests)
    echo "Running ruff format..."
    if ! uv run ruff format .; then
        echo -e "${RED}❌ Ruff format failed${NC}"
        HAS_ERRORS=1
    else
        echo -e "${GREEN}✓ Ruff format passed${NC}"
    fi

    cd ..

    # Re-stage the fixed files
    for file in $BACKEND_FILES; do
        git add "$file" 2>/dev/null || true
    done
fi

# Check if there are any staged frontend files
FRONTEND_FILES=$(echo "$STAGED_FILES" | grep -E "^frontend/.*\.(js|jsx|ts|tsx|css|json)$" || true)

if [ -n "$FRONTEND_FILES" ]; then
    echo -e "${BLUE}Checking frontend files...${NC}"

    # Change to frontend directory
    cd frontend

    # Run biome check with auto-fix
    echo "Running biome check..."
    if ! npm run check --silent; then
        echo -e "${RED}❌ Biome found errors that couldn't be auto-fixed${NC}"
        HAS_ERRORS=1
    else
        echo -e "${GREEN}✓ Biome check passed${NC}"
    fi

    cd ..

    # Re-stage the fixed files
    for file in $FRONTEND_FILES; do
        git add "$file" 2>/dev/null || true
    done
fi

# Check for secrets with gitleaks (if installed)
if command -v gitleaks &> /dev/null; then
    echo -e "${BLUE}Scanning for secrets...${NC}"
    if ! gitleaks protect --staged --config .github/.gitleaks.toml --verbose; then
        echo -e "${RED}❌ Gitleaks found potential secrets${NC}"
        echo -e "${YELLOW}Remove secrets before committing or update .github/.gitleaks.toml if false positive${NC}"
        HAS_ERRORS=1
    else
        echo -e "${GREEN}✓ No secrets detected${NC}"
    fi
else
    echo -e "${YELLOW}⚠️  Gitleaks not installed - skipping secret scanning${NC}"
    echo -e "${YELLOW}   Install: https://github.com/gitleaks/gitleaks#installing${NC}"
fi

# Exit with error if any checks failed
if [ $HAS_ERRORS -eq 1 ]; then
    echo ""
    echo -e "${RED}❌ Pre-commit checks failed. Please fix the errors above and try again.${NC}"
    echo -e "${YELLOW}Tip: Auto-fixable issues have been staged. Review changes with 'git diff --cached'${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}✅ All pre-commit checks passed!${NC}"
exit 0
