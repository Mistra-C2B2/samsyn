name: Docker Build Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test-backend-build:
    name: Test Backend Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: samsyn-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test backend container with PostgreSQL
        run: |
          # Start PostgreSQL container
          docker run --rm -d --name test-postgres \
            -e POSTGRES_USER=test \
            -e POSTGRES_PASSWORD=testpass \
            -e POSTGRES_DB=samsyn_test \
            -p 5432:5432 \
            postgis/postgis:16-3.4

          # Wait for PostgreSQL to be ready
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if docker exec test-postgres pg_isready -U test >/dev/null 2>&1; then
              echo "✅ PostgreSQL is ready"
              break
            fi
            sleep 1
          done

          # Start backend container
          docker run --rm -d --name samsyn-backend-test \
            --network host \
            -e DATABASE_URL=postgresql://test:testpass@localhost:5432/samsyn_test \
            -e CLERK_SECRET_KEY=sk_test_dummy \
            -e CLERK_PUBLISHABLE_KEY=pk_test_dummy \
            -e CLERK_JWKS_URL=https://test.clerk.accounts.dev/.well-known/jwks.json \
            -e DEV_MODE=false \
            samsyn-backend:test

          # Wait for backend to start
          echo "Waiting for backend to start..."
          sleep 10

          # Check if container is running
          if docker ps | grep -q samsyn-backend-test; then
            echo "✅ Backend container started successfully"
          else
            echo "❌ Backend container failed to start"
            docker logs samsyn-backend-test || true
            docker stop test-postgres || true
            exit 1
          fi

          # Show logs
          echo "Backend logs:"
          docker logs samsyn-backend-test

          # Cleanup
          docker stop samsyn-backend-test || true
          docker stop test-postgres || true

  test-frontend-build:
    name: Test Frontend Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate nginx template has DOMAIN placeholders
        run: |
          if grep -q '\${DOMAIN}' frontend/nginx.conf.template; then
            echo "✅ Template contains DOMAIN placeholders"
            DOMAIN_COUNT=$(grep -o '\${DOMAIN}' frontend/nginx.conf.template | wc -l)
            echo "   Found $DOMAIN_COUNT placeholders"
          else
            echo "❌ Template missing DOMAIN placeholders"
            exit 1
          fi

      - name: Build frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: samsyn-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_CLERK_PUBLISHABLE_KEY=pk_test_dummy
            VITE_API_URL=http://localhost:8000

      - name: Test frontend container starts
        run: |
          docker run --rm -d --name samsyn-frontend-test \
            -e DOMAIN=test.example.com \
            -p 8080:80 \
            samsyn-frontend:test

          # Wait for container to start
          sleep 5

          # Check if container is running
          if docker ps | grep -q samsyn-frontend-test; then
            echo "✅ Frontend container started successfully"
          else
            echo "❌ Frontend container failed to start"
            docker logs samsyn-frontend-test || true
            exit 1
          fi

          # Test health endpoint
          if curl -f http://localhost:8080/health; then
            echo "✅ Frontend health check passed"
          else
            echo "❌ Frontend health check failed"
            docker logs samsyn-frontend-test
            docker stop samsyn-frontend-test
            exit 1
          fi

          # Test CSP headers are present
          HEADERS=$(curl -sI http://localhost:8080/)
          if echo "$HEADERS" | grep -qi "content-security-policy"; then
            echo "✅ CSP headers present"
          else
            echo "❌ CSP headers missing"
            echo "$HEADERS"
            docker stop samsyn-frontend-test
            exit 1
          fi

          # Stop container
          docker stop samsyn-frontend-test

      - name: Verify nginx configuration
        run: |
          docker run --rm \
            -e DOMAIN=test.example.com \
            --entrypoint /bin/sh \
            samsyn-frontend:test \
            -c "cat /etc/nginx/nginx.conf.template | grep -c '\${DOMAIN}' && echo '✅ Template contains DOMAIN placeholders'"

  test-docker-compose:
    name: Test Docker Compose Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create test environment file
        run: |
          cat > .env <<EOF
          POSTGRES_USER=test
          POSTGRES_PASSWORD=testpass
          POSTGRES_DB=samsyn_test
          DOMAIN=test.example.com
          VITE_CLERK_PUBLISHABLE_KEY=pk_test_dummy
          VITE_API_URL=http://localhost:8000
          CLERK_SECRET_KEY=sk_test_dummy
          CLERK_PUBLISHABLE_KEY=pk_test_dummy
          CLERK_WEBHOOK_SECRET=whsec_test
          CLERK_JWKS_URL=https://test.clerk.accounts.dev/.well-known/jwks.json
          FRONTEND_URL=http://localhost:3000
          GFW_API_TOKEN=test_token
          EOF

      - name: Test production docker-compose build
        run: |
          docker compose -f docker-compose.prod.yml build --parallel

      - name: Verify all services built
        run: |
          if docker images | grep -q samsyn-backend-prod && docker images | grep -q samsyn-frontend-prod; then
            echo "✅ All services built successfully"
          else
            echo "❌ Some services failed to build"
            docker images | grep samsyn
            exit 1
          fi

  build-summary:
    name: Docker Build Summary
    runs-on: ubuntu-latest
    needs: [test-backend-build, test-frontend-build, test-docker-compose]
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "=========================================="
          echo "Docker Build Test Results"
          echo "=========================================="
          echo "Backend Build: ${{ needs.test-backend-build.result }}"
          echo "Frontend Build: ${{ needs.test-frontend-build.result }}"
          echo "Docker Compose Build: ${{ needs.test-docker-compose.result }}"
          echo "=========================================="

          if [ "${{ needs.test-backend-build.result }}" == "success" ] && \
             [ "${{ needs.test-frontend-build.result }}" == "success" ] && \
             [ "${{ needs.test-docker-compose.result }}" == "success" ]; then
            echo "✅ All Docker builds passed!"
            exit 0
          else
            echo "❌ Some Docker builds failed"
            exit 1
          fi
